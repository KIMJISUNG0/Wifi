<!doctype html>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sender - P2P Photo</title>
<style>
  body{font-family:system-ui,apple-system,Segoe UI,Roboto,Arial;margin:16px}
  button,input,textarea{font-size:16px}
  textarea{width:100%;height:120px}
  .card{border:1px solid #ddd;border-radius:12px;padding:12px;margin:12px 0}
</style>
<h2>ğŸ“¤ Sender</h2>
<div class="card">
  <p>1) ì „ì†¡í•  ì‚¬ì§„ ì„ íƒ</p>
  <input id="file" type="file" accept="image/*">
  <p id="fileInfo"></p>
</div>
<div class="card">
  <p>2) Offer ìƒì„± â†’ ì•„ë˜ í…ìŠ¤íŠ¸ë¥¼ ë³µì‚¬í•´ì„œ Receiverì— ë¶™ì—¬ë„£ê¸°</p>
  <button id="makeOffer">Offer ë§Œë“¤ê¸°</button>
  <textarea id="offerOut" readonly></textarea>
</div>
<div class="card">
  <p>3) Receiverì˜ Answerë¥¼ ì•„ë˜ì— ë¶™ì—¬ë„£ê³  â€œAnswer ì ìš©â€</p>
  <textarea id="answerIn" placeholder="ì—¬ê¸°ì— Answer JSON ë¶™ì—¬ë„£ê¸°"></textarea>
  <button id="applyAnswer">Answer ì ìš©</button>
  <p id="status">ìƒíƒœ: ëŒ€ê¸°</p>
</div>
<div class="card">
  <p>4) ì—°ê²°ë˜ë©´ â€œì‚¬ì§„ ì „ì†¡â€</p>
  <button id="sendBtn" disabled>ì‚¬ì§„ ì „ì†¡</button>
</div>
<script>
const pc = new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
const channel = pc.createDataChannel('file');
let fileBuf = null;
const $ = id => document.getElementById(id);
$('file').onchange = async e => {
  const f = e.target.files?.[0];
  if(!f){ $('fileInfo').textContent = 'ì„ íƒëœ íŒŒì¼ ì—†ìŒ'; return; }
  $('fileInfo').textContent = `${f.name} (${f.size} bytes)`;
  fileBuf = await f.arrayBuffer();
};
channel.binaryType = 'arraybuffer';
channel.onopen = () => { $('status').textContent = 'ìƒíƒœ: ì—°ê²°ë¨'; $('sendBtn').disabled=false; };
channel.onclose = () => { $('status').textContent = 'ìƒíƒœ: ì—°ê²° ì¢…ë£Œ'; $('sendBtn').disabled=true; };
function waitIceComplete(){
  return new Promise(res=>{
    if(pc.iceGatheringState==='complete') return res();
    const chk=()=> pc.iceGatheringState==='complete' && (pc.removeEventListener('icegatheringstatechange',chk),res());
    pc.addEventListener('icegatheringstatechange',chk);
    setTimeout(res,1500);
  });
}
$('makeOffer').onclick = async () => {
  await pc.setLocalDescription(await pc.createOffer());
  await waitIceComplete();
  $('offerOut').value = JSON.stringify(pc.localDescription);
};
$('applyAnswer').onclick = async () => {
  try{
    const ans = JSON.parse(($('answerIn').value||'').trim());
    await pc.setRemoteDescription(ans);
    $('status').textContent='ìƒíƒœ: Answer ì ìš©ë¨, ì—°ê²° ëŒ€ê¸°';
  }catch(e){ alert('Answer ì ìš© ì˜¤ë¥˜: '+e); }
};
$('sendBtn').onclick = async () => {
  if(!fileBuf){ alert('ì‚¬ì§„ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”'); return; }
  const meta = {type:'meta', filename: $('file').files[0].name, size: fileBuf.byteLength, mime: $('file').files[0].type || 'image/jpeg'};
  channel.send(JSON.stringify(meta));
  const chunkSize = 64*1024;
  for(let i=0;i<fileBuf.byteLength;i+=chunkSize){
    channel.send(fileBuf.slice(i, i+chunkSize));
    await new Promise(r=>setTimeout(r,2));
  }
  channel.send(JSON.stringify({type:'end'}));
  alert('ì „ì†¡ ì™„ë£Œ!');
};
</script>
