<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>📤 Sender</title>
</head>
<body>
  <h2>📤 Sender</h2>
  <input type="file" id="fileInput">
  <button id="sendBtn">Send File</button>
  <p>Status: <span id="status">Waiting...</span></p>

  <script>
    const WS_URL = "wss://spring-salad-09fe.slvjek.workers.dev";
    const room = "testRoom";   // 방 이름 (같게 맞추면 자동 연결)
    const role = "sender";

    const ws = new WebSocket(`${WS_URL}?room=${room}&role=${role}`);
    const pc = new RTCPeerConnection();

    let dataChannel = pc.createDataChannel("fileTransfer");
    dataChannel.onopen = () => document.getElementById("status").textContent = "Connected ✅";
    dataChannel.onmessage = e => console.log("Receiver says:", e.data);

    pc.onicecandidate = e => {
      if (e.candidate) {
        ws.send(JSON.stringify({ type: "candidate", candidate: e.candidate }));
      }
    };

    ws.onmessage = async e => {
      const msg = JSON.parse(e.data);
      if (msg.type === "answer") {
        await pc.setRemoteDescription(new RTCSessionDescription(msg.answer));
      } else if (msg.type === "candidate") {
        await pc.addIceCandidate(new RTCIceCandidate(msg.candidate));
      }
    };

    document.getElementById("sendBtn").onclick = async () => {
      const file = document.getElementById("fileInput").files[0];
      if (!file) return alert("No file selected!");
      dataChannel.send(file.name); // 파일명 먼저 전송
      const arrayBuffer = await file.arrayBuffer();
      dataChannel.send(arrayBuffer);
      alert("File sent!");
    };

    async function start() {
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      ws.onopen = () => ws.send(JSON.stringify({ type: "offer", offer }));
    }
    start();
  </script>
</body>
</html>
