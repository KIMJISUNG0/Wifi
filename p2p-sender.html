<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>📤 P2P Sender</title>
<style>
  :root{--bg:#0f172a;--card:#111827;--fg:#e5e7eb;--muted:#9ca3af;--acc:#22c55e;--warn:#f59e0b;--err:#ef4444;--br:18px}
  *{box-sizing:border-box} body{margin:0;background:linear-gradient(180deg,#0b1220,#0f172a);} 
  .wrap{max-width:900px;margin:0 auto;padding:24px;color:var(--fg);font-family:ui-sans-serif,system-ui,Apple SD Gothic Neo,Segoe UI,Roboto,Arial}
  .hero{display:flex;gap:16px;align-items:center;margin-bottom:18px}
  .badge{padding:6px 10px;border-radius:999px;background:#1f2937;color:#a7f3d0;border:1px solid #10b98133;font-weight:600}
  .card{background:linear-gradient(180deg,#0f172a,#0b1220);border:1px solid #1f2937;border-radius:var(--br);padding:20px;margin:14px 0;box-shadow:0 10px 25px #0006}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .field{flex:1;min-width:220px}
  input[type="text"]{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #334155;background:#0b1324;color:var(--fg);outline:none}
  input[type="file"]{display:none}
  .filebox{display:inline-flex;gap:10px;align-items:center;padding:12px 14px;border:1px dashed #334155;background:#0b1324;color:var(--fg);border-radius:12px;cursor:pointer}
  .btn{padding:12px 16px;border:1px solid #334155;border-radius:12px;background:#0b1324;color:var(--fg);cursor:pointer}
  .btn.primary{border-color:#10b98155;background:linear-gradient(180deg,#052e2b,#0b1324)}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .status{font-weight:600}
  .status.ok{color:#34d399}.status.warn{color:var(--warn)}.status.err{color:var(--err)}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
  .filecard{border:1px solid #1f2937;border-radius:14px;padding:12px;background:#0b1324}
  .name{font-weight:600;margin:0 0 6px}
  .meta{color:var(--muted);font-size:14px;margin-bottom:8px}
  .bar{height:8px;background:#1f2937;border-radius:999px;overflow:hidden}
  .fill{height:100%;width:0;background:linear-gradient(90deg,#10b981,#22c55e)}
  .hint{color:#9ca3af;font-size:14px}
</style>

<div class="wrap">
  <div class="hero">
    <span class="badge">P2P • Sender</span>
    <div class="status" id="stat">초기화…</div>
  </div>

  <div class="card">
    <div class="row">
      <div class="field">
        <label class="hint">Room</label>
        <input id="room" type="text" placeholder="같은 방 코드로 접속하세요 (예: abc123)">
      </div>
      <button class="btn primary" id="connectBtn">연결 시작</button>
    </div>
    <p class="hint" style="margin-top:8px">이 페이지 주소 뒤에 <code>?room=abc123</code> 처럼 붙여도 자동 입력됩니다.</p>
  </div>

  <div class="card">
    <div class="row">
      <label for="files" class="filebox">📷 전송할 사진 선택 (여러 장 가능)</label>
      <input id="files" type="file" accept="image/*" multiple>
      <button class="btn" id="sendBtn" disabled>사진 전송</button>
    </div>
    <p class="hint" id="selInfo" style="margin-top:8px">아직 선택된 파일이 없습니다.</p>
    <div class="grid" id="list"></div>
  </div>
</div>

<script>
const qs = new URLSearchParams(location.search);
const $ = s=>document.querySelector(s);
const stat = $('#stat'); const list = $('#list'); const selInfo = $('#selInfo');
$('#room').value = qs.get('room') || '';
const WS_BASE = "wss://spring-salad-09fe.slvjek.workers.dev/p2p/";

let pc, dc, ws;
let files = [];

$('#files').addEventListener('change', () => {
  files = Array.from($('#files').files||[]);
  if (!files.length) { selInfo.textContent = '아직 선택된 파일이 없습니다.'; $('#sendBtn').disabled = true; list.innerHTML=''; return; }
  $('#sendBtn').disabled = !dc || dc.readyState!=='open';
  selInfo.textContent = `${files.length}개 선택됨`;
  list.innerHTML = files.map((f,i)=>cardHTML(f,i)).join('');
});

$('#connectBtn').onclick = async () => {
  const room = ($('#room').value || '').trim() || 'test';
  $('#room').value = room;
  await start(room);
  $('#sendBtn').disabled = !files.length;
};

$('#sendBtn').onclick = async () => {
  if (!dc || dc.readyState!=='open') return alert('P2P 연결이 먼저 필요합니다.');
  if (!files.length) return alert('사진을 선택하세요.');
  for (let i=0;i<files.length;i++){
    await sendOne(files[i], i);
  }
  alert('모든 사진 전송 완료!');
};

// ---- UI helpers
function cardHTML(f,i){
  const kb = (f.size/1024).toFixed(1);
  return `<div class="filecard" id="card-${i}">
    <p class="name">${escapeHTML(f.name)}</p>
    <p class="meta">${kb} KB • ${f.type||'unknown'}</p>
    <div class="bar"><div class="fill" id="bar-${i}"></div></div>
  </div>`;
}
function setStatus(text,type='ok'){ stat.textContent=text; stat.className='status '+type; }
function escapeHTML(s){ return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

// ---- WebRTC (P2P)
async function start(room){
  setStatus('신호 서버 연결 중…','warn');
  ws = new WebSocket(WS_BASE + encodeURIComponent(room));
  ws.onopen = ()=> setStatus('신호 연결됨 • P2P 협상중…','warn');
  ws.onmessage = async (e)=>{
    const msg = JSON.parse(e.data);
    if (msg.type==='answer') await pc.setRemoteDescription(new RTCSessionDescription(msg));
    else if (msg.type==='ice') try{ await pc.addIceCandidate(msg.candidate); }catch{}
  };

  const iceServers = [{urls:'stun:stun.l.google.com:19302'}];
  pc = new RTCPeerConnection({iceServers});
  dc = pc.createDataChannel('file'); dc.binaryType='arraybuffer';
  dc.onopen  = ()=> { setStatus('P2P 연결됨 • 전송 준비 완료','ok'); $('#sendBtn').disabled = !files.length; };
  dc.onclose = ()=> setStatus('P2P 끊김','err');
  pc.onicecandidate = (e)=>{ if(e.candidate) ws?.send(JSON.stringify({type:'ice', candidate:e.candidate})); };

  const offer = await pc.createOffer(); await pc.setLocalDescription(offer);
  ws.onopen = ()=> ws.send(JSON.stringify(offer)); // {type:'offer', sdp:...}
}

// ---- 전송 (분할 + 백프레셔)
async function sendOne(file, idx){
  // 메타 먼저
  dc.send(JSON.stringify({type:'meta', name:file.name, mime:file.type, size:file.size}));
  const buf = await file.arrayBuffer();
  const view = new Uint8Array(buf);
  const CHUNK = 16*1024;
  dc.bufferedAmountLowThreshold = 1_000_000; // 1MB

  let sent = 0;
  for (let i=0;i<view.byteLength;i+=CHUNK){
    const chunk = view.slice(i, i+CHUNK);
    dc.send(chunk);
    sent += chunk.byteLength;
    // 진행률
    const p = Math.round((sent / view.byteLength) * 100);
    const bar = document.getElementById('bar-'+idx);
    if (bar) bar.style.width = p + '%';

    // 백프레셔: 버퍼가 너무 차면 대기
    if (dc.bufferedAmount > 5_000_000) {
      await new Promise(res=>{
        const onlow = ()=>{ dc.removeEventListener('bufferedamountlow', onlow); res(); };
        dc.addEventListener('bufferedamountlow', onlow, {once:true});
      });
    }
    await microTick();
  }
  dc.send(JSON.stringify({type:'eof'}));
}
function microTick(){ return new Promise(r=>setTimeout(r,0)); }
</script>
