<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>📤 P2P Sender</title>
<style>
  :root{
    --bg: #0b0f1a; --panel:#0f172a; --ink:#e5e7eb; --mute:#9ca3af;
    --line:#1f2937; --glow:#22c55e; --warn:#f59e0b; --err:#ef4444;
    --rim: 18px
  }
  *{box-sizing:border-box}
  body{margin:0;background:
    radial-gradient(1200px 500px at 10% -10%, #0a1b2f55, transparent),
    radial-gradient(800px 800px at 100% 10%, #05322a55, transparent),
    linear-gradient(180deg, #0a0f1e, #0b0f1a);
    color:var(--ink); font-family: ui-sans-serif, system-ui, Segoe UI, Roboto, Apple SD Gothic Neo, Arial}
  .wrap{max-width:980px;margin:0 auto;padding:28px}
  .hero{display:flex;align-items:center;gap:14px;margin-bottom:18px}
  .brand{font-weight:800; letter-spacing:.5px; background:linear-gradient(90deg,#86efac,#60a5fa);
    -webkit-background-clip:text; background-clip:text; color:transparent; font-size:24px}
  .badge{padding:6px 12px;border-radius:999px;border:1px solid #10b98133;background:#0b1324;color:#a7f3d0;font-weight:600}
  .panel{background:linear-gradient(180deg,#0f172a,#0b1324); border:1px solid var(--line); border-radius:var(--rim); padding:18px; box-shadow:0 10px 30px #0006; margin:14px 0}
  .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
  .field{flex:1; min-width:220px}
  input[type="text"]{width:100%; padding:12px 14px; border-radius:14px; border:1px solid #334155; background:#0b1324; color:var(--ink); outline:none}
  input[type="file"]{display:none}
  .filepick{display:inline-flex; align-items:center; gap:10px; padding:12px 14px; border:1px dashed #334155; background:#0b1324; color:var(--ink); border-radius:14px; cursor:pointer}
  .btn{padding:12px 16px; border:1px solid #334155; border-radius:14px; background:#0b1324; color:var(--ink); cursor:pointer}
  .btn.primary{border-color:#10b98155; background:linear-gradient(180deg,#052e2b,#0b1324)}
  .btn:disabled{opacity:.5; cursor:not-allowed}
  .status{font-weight:700}
  .status.ok{color:#34d399}.status.warn{color:var(--warn)}.status.err{color:var(--err)}
  .grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:12px}
  .card{border:1px solid var(--line); border-radius:16px; background:#0b1324; overflow:hidden}
  .meta{padding:10px 12px}
  .name{margin:0 0 6px; font-weight:700}
  .dim{color:var(--mute); font-size:13px}
  .bar{height:8px; background:#1f2937; border-radius:999px; overflow:hidden; margin-top:8px}
  .fill{height:100%; width:0; background:linear-gradient(90deg,#10b981,#22c55e)}
</style>

<div class="wrap">
  <div class="hero">
    <div class="brand">Aurora Beam</div>
    <span class="badge">P2P • Sender</span>
    <div id="stat" class="status warn">대기…</div>
  </div>

  <div class="panel">
    <div class="row">
      <div class="field">
        <label class="dim">Room</label>
        <input id="room" type="text" placeholder="같은 방 코드를 입력 (예: abc123)">
      </div>
      <button class="btn primary" id="connectBtn">연결</button>
    </div>
    <p class="dim" style="margin-top:8px">주소 뒤에 <code>?room=abc123</code>를 붙여도 자동 입력됩니다.</p>
  </div>

  <div class="panel">
    <div class="row">
      <label class="filepick" for="files">📷 전송할 사진 고르기 (여러 장)</label>
      <input id="files" type="file" accept="image/*" multiple>
      <button class="btn" id="sendBtn" disabled>전송</button>
    </div>
    <p id="selInfo" class="dim" style="margin-top:8px">선택된 파일 없음</p>
    <div id="grid" class="grid"></div>
  </div>
</div>

<script>
const $ = s=>document.querySelector(s);
const qs = new URLSearchParams(location.search);
$('#room').value = qs.get('room') || '';

const WS_BASE = "wss://spring-salad-09fe.slvjek.workers.dev/"; // ?room=<ID> 쿼리 사용
const iceServers = [{urls:'stun:stun.l.google.com:19302'}];

let ws, pc, dc, files=[];
const stat = $('#stat'), grid = $('#grid'), selInfo = $('#selInfo');

function setStat(t,cls='warn'){ stat.textContent=t; stat.className='status '+cls; }
const esc = s => s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));

$('#files').addEventListener('change', ()=>{
  files = Array.from($('#files').files||[]);
  selInfo.textContent = files.length? `${files.length}개 선택됨` : '선택된 파일 없음';
  $('#sendBtn').disabled = !(dc && dc.readyState==='open' && files.length);
  renderList();
});

$('#connectBtn').onclick = async ()=>{
  const room = ($('#room').value||'').trim() || 'abc123';
  $('#room').value = room;
  await start(room);
  $('#sendBtn').disabled = !(dc && dc.readyState==='open' && files.length);
};

$('#sendBtn').onclick = async ()=>{
  if (!dc || dc.readyState!=='open') return alert('P2P 연결이 필요합니다.');
  if (!files.length) return alert('사진을 선택하세요.');
  for (let i=0;i<files.length;i++) await sendOne(files[i], i);
  alert('전송 완료!');
};

// --- UI
function renderList(){
  grid.innerHTML = files.map((f,i)=>(
    `<div class="card" id="card-${i}">
      <div class="meta">
        <p class="name">${esc(f.name)}</p>
        <p class="dim">${(f.size/1024).toFixed(1)} KB · ${f.type||'image'}</p>
        <div class="bar"><div class="fill" id="bar-${i}"></div></div>
      </div>
    </div>`
  )).join('');
}

// --- WebRTC Signaling + DataChannel
async function start(room){
  setStat('신호 서버 연결 중…','warn');
  ws = new WebSocket(`${WS_BASE}?room=${encodeURIComponent(room)}`);

  pc = new RTCPeerConnection({iceServers});
  dc = pc.createDataChannel('file');           // ★ 먼저 생성
  dc.binaryType = 'arraybuffer';
  dc.onopen  = ()=> setStat('P2P 연결됨 · 전송 준비 완료','ok');
  dc.onclose = ()=> setStat('P2P 끊김','err');

  pc.onicecandidate = (e)=>{
    if(e.candidate) ws?.send(JSON.stringify({type:'candidate', candidate:e.candidate}));
  };

  ws.onmessage = async (evt)=>{
    const msg = JSON.parse(evt.data);
    if (msg.type==='answer') {
      await pc.setRemoteDescription(new RTCSessionDescription(msg.answer));
    } else if (msg.type==='candidate' && msg.candidate) {
      try{ await pc.addIceCandidate(new RTCIceCandidate(msg.candidate)); }catch{}
    }
  };

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  ws.onopen = ()=> ws.send(JSON.stringify({type:'offer', offer}));
  setStat('P2P 협상 중…','warn');
}

// --- 전송 (분할 + 백프레셔 & 진행률)
async function sendOne(file, idx){
  // 메타 전송
  dc.send(JSON.stringify({type:'meta', name:file.name, mime:file.type, size:file.size}));

  const buf = await file.arrayBuffer();
  const view = new Uint8Array(buf);
  const CHUNK = 16*1024;
  dc.bufferedAmountLowThreshold = 1_000_000;

  let sent = 0;
  for (let i=0;i<view.byteLength;i+=CHUNK){
    const chunk = view.slice(i, i+CHUNK);
    dc.send(chunk);
    sent += chunk.byteLength;
    const p = Math.round((sent/view.byteLength)*100);
    const bar = document.getElementById('bar-'+idx);
    if (bar) bar.style.width = p + '%';

    if (dc.bufferedAmount > 5_000_000) { // 5MB 이상 쌓이면 대기
      await new Promise(res=>{
        const onlow = ()=>{ dc.removeEventListener('bufferedamountlow', onlow); res(); };
        dc.addEventListener('bufferedamountlow', onlow, {once:true});
      });
    }
    await new Promise(r=>setTimeout(r,0));
  }
  dc.send(JSON.stringify({type:'eof'}));
}
</script>
