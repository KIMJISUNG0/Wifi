<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>📥 P2P Receiver</title>
<style>
  :root{
    --bg:#0b0f1a; --panel:#0f172a; --ink:#e5e7eb; --mute:#9ca3af; --line:#1f2937;
    --rim:18px; --ok:#34d399; --warn:#f59e0b; --err:#ef4444
  }
  *{box-sizing:border-box}
  body{margin:0;background:
    radial-gradient(1100px 600px at 100% -10%, #132a4f66, transparent),
    radial-gradient(800px 700px at 0% 10%, #08302566, transparent),
    linear-gradient(180deg,#0a0f1e,#0b0f1a);
    color:var(--ink); font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Arial}
  .wrap{max-width:980px;margin:0 auto;padding:28px}
  .hero{display:flex;align-items:center;gap:14px;margin-bottom:18px}
  .brand{font-weight:800; letter-spacing:.5px; background:linear-gradient(90deg,#93c5fd,#86efac);
    -webkit-background-clip:text; background-clip:text; color:transparent; font-size:24px}
  .badge{padding:6px 12px;border-radius:999px;border:1px solid #60a5fa33;background:#0b1324;color:#93c5fd;font-weight:600}
  .status{font-weight:700}
  .status.ok{color:var(--ok)} .status.warn{color:var(--warn)} .status.err{color:var(--err)}
  .panel{background:linear-gradient(180deg,#0f172a,#0b1324); border:1px solid var(--line); border-radius:var(--rim); padding:18px; box-shadow:0 10px 30px #0006; margin:14px 0}
  .dim{color:var(--mute); font-size:14px}
  .grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px}
  .item{border:1px solid var(--line); border-radius:16px; overflow:hidden; background:#0b1324}
  .thumb{aspect-ratio:1/1; width:100%; object-fit:cover; display:block}
  .meta{padding:10px 12px}
  .name{margin:0 0 6px; font-weight:700}
  .meta .dim{font-size:13px}
  .btn{display:inline-block; margin-top:8px; padding:8px 12px; border:1px solid #334155; border-radius:10px; background:#0b1324; color:#e5e7eb; text-decoration:none}
</style>

<div class="wrap">
  <div class="hero">
    <div class="brand">Aurora Beam</div>
    <span class="badge">P2P • Receiver</span>
    <div id="stat" class="status warn">대기…</div>
  </div>

  <div class="panel">
    <p class="dim">같은 <code>?room=abc123</code> 로 Sender와 접속하면 자동 연결됩니다.</p>
  </div>

  <div id="grid" class="grid"></div>
</div>

<script>
const $ = s=>document.querySelector(s);
const qs = new URLSearchParams(location.search);
const room = (qs.get('room')||'abc123').trim();
const WS_URL = `wss://spring-salad-09fe.slvjek.workers.dev/?room=${encodeURIComponent(room)}`;
const iceServers = [{urls:'stun:stun.l.google.com:19302'}];

const stat = $('#stat'), grid = $('#grid');

let meta=null, chunks=[];

function setStat(t,cls='warn'){ stat.textContent=t; stat.className='status '+cls; }

const ws = new WebSocket(WS_URL);
ws.onopen = ()=> setStat('신호 연결됨 · P2P 협상 대기','warn');

const pc = new RTCPeerConnection({iceServers});
pc.onicecandidate = (e)=>{
  if(e.candidate) ws?.send(JSON.stringify({type:'candidate', candidate:e.candidate}));
};

// 시그널 메시지 처리
ws.onmessage = async (evt)=>{
  const msg = JSON.parse(evt.data);
  if (msg.type==='offer') {
    await pc.setRemoteDescription(new RTCSessionDescription(msg.offer));
    pc.ondatachannel = (ev)=>{
      const dc = ev.channel;
      dc.binaryType = 'arraybuffer';
      dc.onopen  = ()=> setStat('P2P 연결됨 · 수신 중','ok');
      dc.onclose = ()=> setStat('P2P 끊김','err');
      dc.onmessage = async (ev2)=>{
        if (typeof ev2.data === 'string') {
          try{
            const j = JSON.parse(ev2.data);
            if (j.type==='meta'){ meta=j; chunks=[]; return; }
            if (j.type==='eof') { assemble(); return; }
          }catch{}
          return;
        }
        let buf = ev2.data;
        if (buf instanceof Blob) buf = await buf.arrayBuffer();
        chunks.push(buf);
      };
    };
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    ws.send(JSON.stringify({type:'answer', answer}));
    setStat('P2P 협상 중…','warn');
  } else if (msg.type==='candidate' && msg.candidate) {
    try{ await pc.addIceCandidate(new RTCIceCandidate(msg.candidate)); }catch{}
  }
};

function assemble(){
  const blob = new Blob(chunks, {type: meta?.mime || 'application/octet-stream'});
  const url  = URL.createObjectURL(blob);
  const name = meta?.name || 'received';

  const card = document.createElement('div');
  card.className='item';
  const img = document.createElement('img');
  img.className='thumb'; img.src=url; img.alt=name;
  const box = document.createElement('div'); box.className='meta';
  const title = document.createElement('p'); title.className='name'; title.textContent = name;
  const small = document.createElement('p'); small.className='dim'; small.textContent =
    (meta?.size? (meta.size/1024).toFixed(1)+' KB · ' : '') + (meta?.mime || '');
  const a = document.createElement('a'); a.className='btn'; a.href=url; a.download=name; a.textContent='⬇️ 다운로드';

  box.appendChild(title); box.appendChild(small); box.appendChild(a);
  card.appendChild(img); card.appendChild(box);
  grid.prepend(card);

  setStat('수신 완료 · 대기 중','ok');
  meta=null; chunks=[];
}
</script>
